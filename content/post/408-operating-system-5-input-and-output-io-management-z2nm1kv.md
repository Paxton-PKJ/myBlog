---
title: 408操作系统—5.输入输出(IO)管理
slug: 408-operating-system-5-input-and-output-io-management-z2nm1kv
url: /post/408-operating-system-5-input-and-output-io-management-z2nm1kv.html
date: '2024-08-02 15:22:35+08:00'
lastmod: '2024-08-02 15:22:36+08:00'
toc: true
tags:
  - '408'
  - 操作系统
categories:
  - 提桶跑路笔记
keywords: 408,操作系统
isCJKLanguage: true
---





## I/O 管理概述

### I/O 设备

#### I/O 设备分类

​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202408012040707.png)​

#### I/O 接口（设备控制器）

CPU 与设备之间的接口

* **主要功能**

  * 接受和识别 CPU 发来的命令
  * 数据交换（设备和控制器的数据交换 + 控制器和主存数据交换）
  * 标识和报告设备的状态，以供 CPU 处理
  * 地址识别；数据缓冲；差错控制
  * <u>设备控制器不属于操作系统范畴，它是属于硬件</u>
* **组成**

  1. **设备控制器 &amp; CPU**

     * **数据线**

       传输读写数据、控制信息、状态信息
     * **地址线**

       传送要访问 I/O 接口中的寄存器编号
     * **控制线**

       发出读写控制信号

     CPU 通过<u>控制线发出命令</u>，通过<u>地址线指明要操作的设备</u>，通过<u>数据线来输入输出数据</u>
  2. **设备控制器 &amp; 设备**

     一对多，每个接口都可以传输<u>数据、控制和状态</u>三种类型信号，用于实现<u>控制器和设备之间通信</u>
  3. **I/O 逻辑**

     * 负责接受和识别 CPU 的命令
     * 根据命令对相应设备发送命令
     * 实现设备控制功能

​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202408012059865.png)​

#### I/O 接口类型

1. **按数据传输方式**

   * 并行接口：一个字节或一个字的所有位同时传送
   * 串行接口：一位一位传送
2. **按主机控制设备的方式**

   程序查询接口、中断接口、DMA 接口等
3. **按功能选择的灵活性**

   可编程接口、不可编程接口

#### I/O 端口

指设备控制器中<u>可被 CPU 直接访问的寄存器</u>

1. 分类

   * **数据寄存器**

     CPU 向 I/O 设备<u>写入需要传输的数据</u>
   * **状态寄存器**

     告知 CPU 已经在工作或工作已经完成

     <u>工作状态，CPU 再发送数据或者命令将无效</u>

     工作已经完成，状态寄存标记成已完成，CPU 才能发送下一个字符和命令
   * **控制寄存器**

     由 cpu 写入以改变设备运行模式或启动命令
2. **编址**

   1. **独立编址**

      每个端口分配一个端口号，端口地址空间和主存地址空间之间独立

      只有操作系统使用指令才能访问端口

      * **优点**

        专用指令程序清晰

        硬件实现简单，只需要少量地址线，寻址速度快
      * **缺点**

        指令少，<u>程序灵活性差</u>

        两组系统<u>增加控制复杂性</u>
   2. **统一编址**

      又称内存映射 I/O，主存地址提供一部分用于 I/O 端口

      * **优点**

        无需专用指令，访存指令即可，<u>程序简单</u>

        端口拥有较大编址空间，访存保护由虚拟存储管理系统实现
      * **缺点**

        主存可用容量变小

        硬件实现复杂，全部地址线参与译码

### I/O 控制方式

<u>控制设备和主机</u>之间的数据传送

发展宗旨：<u>减少 CPU 对 I/O 控制的干预</u>

#### 程序直接控制方式

CPU <u>循环从设备读取一个字节</u>，循环测试设备状态（轮询），直到字节已经在设备控制器的数据寄存器中，取出送入内存

<u>实现简单</u>，但 CPU 大部分时间都在等待完成，利用率低

CPU <u>未采用中断机构</u>，I/O 设备无法报告已完成，CPU 只能主动询问

#### 中断驱动方式

允许 I/O 设备主动打断 CPU 运行并请求服务，使得 CPU 向设备控制器发出一条 I/O 指令后继续其他工作

CPU 和设备并行工作，CPU 效率提升

设备和内存交换<u>数据必须经过 CPU 寄存器</u>，效率低

此方式<u>以字节为单位交换数据</u>，对于<u>块设备效率极低</u>

#### DMA 方式（直接存储器存取）

在 I/O 设备和内存之间开辟直接数据交换通路

* **特性**

  1. 基本传送单位为<u>数据块</u>
  2. 数据不再经过 CPU
  3. 只有<u>开始传送和传送结束时</u>需要 CPU 干预
* **寄存器**

  ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/image-20240802134655-z18f8t8.png)​

  1. **命令/状态寄存器（CR）**

     接收从 CPU 发来的 I/O 命令、有关控制信息，设备的状态
  2. **内存地址寄存器（MAR）**

     存放将数据从设备传送到内存的<u>起始目标地址</u>
  3. **数据寄存器（DR）**

     暂存从设备到内存或从内存到设备的<u>数据</u>
  4. **数据计数器（DC）**

     存放本次要传送的<u>字节数</u>
* **工作流程**

  1. CPU 收到 DMA 请求，向 DMA 控制器发出启动命令，设置 MAR、DC 初值
  2. I/O 控制权交给 DMA，DMA 直接与内存交互，一次传送一个字节，CPU 不参与
  3. 传输结束，DMA 控制器发出中断信号给 CPU

  ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202408021351598.png)​

#### 通道控制方式

I/O 通道是一种特殊的处理机，执行通道指令

* **特性**

  1. CPU、通道、I/O 设备并行工作，资源利用率高
  2. 实现复杂，需要<u>专门 I/O 通道处理器</u>
  3. 一个通道可以控制<u>多台设备与内存数据交换</u>
* **工作流程**

  1. CPU 向通道发出 I/O 指令，指明通道程序在内存位置和要访问的设备
  2. 通道程序执行，完成 I/O 任务后，发出中断请求
* **通道与一般处理机区别**

  指令单一，没有内存，<u>与 CPU 共享内存</u>
* **通道与 DMA 区别**

  通道传输的<u>数据块大小和传输的内存位置</u>由通道控制

  通道可以同时<u>控制多台设备</u>与内存的数据交换

#### 方式比较

​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202408021407539.png)​

### I/O 软件层次结构

​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202408021424982.png)​

1. **用户层软件**

   实现用户交互接口，必须通过系统调用获取服务

   如发送 read 命令
2. **设备独立性软件**

   * **设备独立性**

     也称设备无关性

     应用所用设备不局限于具体物理设备，从而引入逻辑设备和物理设备概念

     应用程序使用逻辑设备名进行请求，系统将逻辑设备名映射为物理设备名

     增加设备分配灵活性，易于实现 I/O 重定向
   * **软件功能**

     1. 执行所有设备的公有操作

        设备分配回收、设备名映射、设备保护、缓冲管理、提供大小统一逻辑块、屏蔽设备交换单位和速率差异
     2. 向用户层提供统一接口指令

        文件系统管理（如文件的创建、删除、读写等操作）
3. **设备驱动程序**

   * 提供与具体设备相关的 I/O 操作接口
   * 直接与硬件设备交互，处理设备特定的命令和状态，解析上层命令为指令
   * 实现设备初始化、配置和中断处理等功能
4. **中断处理程序**

   * 处理来自硬件设备的中断信号
   * 在中断发生时，保存当前的 CPU 状态，执行相应的中断服务例程
   * 通知设备驱动程序已完成相应的 I/O 操作
5. **硬件**

---

**各层次处理过程**

1. 用户需要<u>读取设备内容</u>，通过操作系统提供的 <u>read 命令接口</u>，经过**用户层**
2. 此时使用的通用接口，是每个设备都可以响应的统一命令，经过**设备独立层**进行<u>解析，然后交往下层</u>
3. 不同设备对 read 命令的行为有所不同。需要针对不同的设备，**设备驱动层**将 <u>read 命令解析成不同的指令</u>
4. 命令解析完毕后，需要<u>中断正在运行的进程，转而执行 read 命令</u>，这就需要**中断处理程序**
5. 命令真正抵达**硬件设备**，硬件设备的控制器<u>按照上层传达的命令操控硬件设备</u>，完成相应的功能

### 应用程序 I/O 接口

#### I/O 接口分类

1. **字符设备接口**

   * 用于访问字符设备，如键盘、鼠标、串口设备等
   * 数据按字符流的方式进行读写操作，设立**字符缓冲区**读写字符
   * 通常不支持随机访问，只能<u>顺序读写，传输速率低</u>
   * 输入输出通常采用<u>中断驱动</u>
   * 属于独占设备，提供打开、关闭操作实现<span data-type="text" id="">互斥共享</span>
2. **块设备接口**

   * 用于访问块设备，如<u>硬盘、光驱</u>等
   * 数据以<u>固定大小的块</u>进行读写操作
   * 支持随机访问，可以直接读取或写入特定的块，速度高，可寻址
   * 将上层传来的逻辑抽象命令转化为设备能识别的低层具体操作
   * 磁盘设备 I/O 常用 <span data-type="text" id="">DMA方式</span>
3. **网络设备接口**

   * 用于网络通信，支持数据包的发送和接收
   * 提供连接管理、数据传输、错误处理等功能
   * 支持多种网络协议，如 TCP、UDP 等
   * 网络套接字接口如 socket

#### 阻塞和非阻塞 I/O

- **阻塞 I/O**

  * **工作原理**

    1. 应用程序调用 I/O 函数（如 read、recv）
    2. 如果数据不可用，调用会阻塞，应用程序进入等待状态
    3. 一旦数据可用，I/O 操作完成，函数返回，应用程序继续执行
  * **优点**

    * <u>编程简单</u>，逻辑清晰
    * 适用于<u>不需要高并发处理</u>的场景
  * **缺点**

    * 当等待 I/O 操作完成时，<u>CPU 资源会被浪费</u>
    * <u>不适用于高并发场景</u>，可能导致性能瓶颈

* **非阻塞 I/O**

  * **工作原理**

    1. 应用程序调用非阻塞 I/O 函数（如 read、recv）并立即返回
    2. 如果数据不可用，函数<u>返回一个错误或特殊值</u>，表示数据未准备好
    3. 应用程序可以使用<u>轮询或事件通知机制</u>来检查数据是否可用
  * **优点**

    * 可以提高系统的并发处理能力和 <u>CPU 利用率</u>
    * 适用于<u>需要高并发处理</u>的场景，如网络服务器、实时系统等
  * **缺点**

    * <u>编程复杂度较高</u>，需要处理数据不可用的情况
    * 可能需要使用轮询或事件通知机制，<u>增加了编程难度，轮询将占用 CPU 时间</u>

## 设备独立性软件

## 磁盘和固态硬盘
