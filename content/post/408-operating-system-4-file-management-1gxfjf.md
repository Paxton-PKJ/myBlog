---
title: 408操作系统—4.文件管理
slug: 408-operating-system-4-file-management-1gxfjf
url: /post/408-operating-system-4-file-management-1gxfjf.html
date: '2024-07-21 21:47:28+08:00'
lastmod: '2024-07-25 21:28:36+08:00'
toc: true
tags:
  - '408'
  - 操作系统
categories:
  - 提桶跑路笔记
keywords: 408,操作系统
isCJKLanguage: true
---





* 文件系统基础
* 目录
* 文件系统

## 文件系统基础

### 文件的基本概念

* **文件定义**

  * 以硬盘为载体的存储在计算机上的信息集合
  * 可以是文本、图片、程序
  * 用户进行的输入输出中，以文件作为基本单位
* **文件组成**

  1. 一块存储空间
  2. 分类和索引信息
  3. 访问权限信息
* **文件属性**

  * 文件名称、文件类型
  * 创建者、所有者
  * 位置、大小、保护、创建修改存取信息
* **文件分类**

  1. **性质与用途**

      系统文件、用户文件、库文件
  2. **数据形式**

      源文件、目标文件、可执行文件
  3. **存取控制属性**

      可执行文件、只读文件、读/写文件
  4. **组织形式和处理方式**

      普通文件、目录文件、特殊文件
* **文件特性**

  1. 可以长期存储在硬盘中
  2. 允许可控制的进程间共享访问
  3. 能够被组织成复杂的结构

### 文件的数据结构

#### 文件控制块(File Control Block)

* **概念**

  * FCB存放控制文件需要的各种信息
  * FCB实现<u>**按名存取**</u>
  * <u>FCB的集合称为</u>​<u>**文件目录，**</u>​<u>文件目录也被视为一个</u>​<u>**目录文件**</u>
  * 目录文件存放目录中所有子目录文件和数据文件目录
  * 一个FCB对应一个文件
* **主要包含信息**

  * **基本信息**

    文件名、文件物理位置、文件逻辑结构、文件物理结构
  * **存取控制信息**

    文件主、核准用户或一般用户的存取权限
  * **使用信息**

    文件建立时间、上次修改时间等

#### 索引节点

* **概念**

  * **文件描述信息**单独形成**索引节点**（i节点inode）
  * **文件名**和**索引节点号**（索引节点指针）构成**目录项**，下图为一个目录

    ​![image](assets/image-20240715204737-1lprt6n.png)​
  * 记录文件的元信息，文件的唯一表示
  * 索引节点占用磁盘空间
  * <u>使用索引节点可以减少文件查找时的I/O量</u>

    原因：检索目录时只用到了文件名，不需要其他信息，因此将文件名以外的其他信息从目录中剥离成为索引节点，减少查找时调入内存的目录大小

  ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/image-20240715205409-27x34xh.png)​
* **分类**

  1. **磁盘索引节点**

      存放在磁盘上的索引节点

      <u>包含内容：</u>文件主标识符、文件类型、文件存取权限、文件物理地址、文件长度、文件链接计数、文件存取时间
  2. **内存索引节点**

      存放在内存中的索引节点，文件打开后，将磁盘索引节点复制到内存中

      <u>新增内容:</u>索引节点编号、状态、访问计数、逻辑设备号、链接指针

### 文件的操作

#### **文件的基本操作**

* **创建文件**

  1. 分配外存空间
  2. 创建目录项
* **删除文件**

  1. 文件名查找目录
  2. 删除文件对应目录项和FCB
  3. 回收磁盘空间和内存空间
* **读文件**

  1. 文件名查找目录
  2. 目录项得到外存地址
  3. 通过读指针进程读操作
* **写文件**

  同读文件，每次发生写操作时更新写指针

#### **文件打开的过程**

1. 调用open系统调用
2. 根据文件名搜索目录，
3. 将目录项从外存复制到内存**打开文件表**的一个表目中
4. 将该表目的编号(也叫索引)返回给用户
5. <u>当再次请求打开时可节省检索开销</u>

#### **多进程同时打开文件**

采用<u>**整个系统打开文件表**</u>​<u>和</u>​<u>**每个进程打开文件表**</u>

* **整个系统表**

  包含与进程无关的信息

  如文件在磁盘上的位置、访问日期和文件大小
* **每个进程表**

  保存的是进程对文件的使用信息

  如文件的当前读写指针、文件访问权限、指向系统表中项目指针
* **过程**

  进程打开一个文件，系统表和该进程表包含文件条目

  当另一进程打开同一文件，只在自己进程表添加条目并指向系统表即可

  **打开计数器**记录打开文件的进程数量，位于系统表中

  调用close关闭文件，删除进程表中对应条目，打开计数器-1，<u>归零时即可从系统表中删除该条目</u>
* **文件描述符（文件句柄）**

  只要完成open调用，再使用 read、write、Lseek、close等文件操作的系统调用，就不再使用文件名，而使用文件描述符

  **<u>即文件名不是打开文件表的一部分</u>**

#### 文件打开和关闭的关联信息

* **文件指针**

  跟踪上次读写位置作为当前文件位置的指针

  对打开文件的某个进程唯一，因此必须与磁盘文件属性分开保存
* **文件打开计数**

  记录当前文件打开和关闭的数量

  因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件
* **文件磁盘位置**

  大多数文件操作要求系统修改文件数据

  查找磁盘上的文件所需的信息保存在内存中，以便系统不必为每个操作都从磁盘上读取该信息
* **访问权限**

  每个进程打开文件都需要有一个访问模式(创建、只读、读写、添加等)

  保存在进程的打开文件表中，以便操作系统能够允许或拒绝后续的I/O请求

### 文件保护

1. **文件保护的目的**

    防止文件共享导致文件被破坏，或未经核准的用户修改文件，即解决文件读写执行的许可问题
2. **访问类型**

    <u>读、写、执行、添加、删除、列表清单</u>

    对于高层功能重命名、复制、编辑等可以通过上述低级功能的请求完成，因此<u>保护可以只在低层提供</u>
3. **访问控制**

    * **访问控制列表（Access-Control List，ACL）**

      使用访问控制列表规定每个<u>用户名</u>以及<u>所允许的访问类型</u>

      ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/image-20240718210806-lulh2e7.png)​

      对于方法二：拥有者按拥有者权限访问，若用户与文件主同组按同组权限访问，否则按其他用户访问
    * **口令**

      建立文件时提供口令，建立FCB时附带口令

      用户访问时必须提供口令

      口令存储在系统内，<u>不安全</u>
    * **密码**

      对文件加密，访问需要秘钥

      保密性强，但<u>编码译码耗时</u>

    **<u>口令和密码没有控制用户的访问类型</u>**

### 文件的逻辑结构

用户角度出发看到的文件组织形式，即逻辑层面的组织

#### 无结构文件/流式文件

由字符流构成的最简单的文件组织形式，是<u>有序相关信息项</u>的集合，以<u>字节为单位</u>

无结构文件对记录的访问<u>只能通过穷举搜索进行</u>

对基本信息单元操作不多的文件适合该方式，如源代码文件，目标代码文件

#### **有结构文件/记录式文件**

<u>由一个以上记录构成的文件，由记录长度可分为：</u>

1. **定长记录**

    文件中所有<u>记录的长度都是相同</u>的，各数据项都在记录中的相同位置，具有相同的长度

    检索记录的速度快，方便用户对文件进行处理，广泛用于数据处理中
2. **变长记录**

    文件中各记录的长度不一定相同，原因可能是记录中所包含的数据项数目不同，也可能是数据项本身的长度不定

    检索记录<u>只能顺序查找</u>，速度慢

<u>有结构文件按记录的组织形式可以分为：</u>

1. **顺序文件**

    文件记录按顺序排列，<u>记录可为定长记录顺序文件、变长记录顺序文件</u>

    记录排列有两种结构

    1. **串结构**

        记录<u>顺序与关键字无关</u>，通常是按<u>存入的先后时间进行排列</u>

        必须<u>从头开始顺序依次查找</u>，比较费时
    2. **顺序结构**

        记录按<u>关键字顺序排列</u>

        定长记录顺序文件，检索时<u>可采用折半查找</u>，效率较高
2. **索引文件**

    定长记录可直接计算得到记录地址，变长记录需要顺序累加来查找，效率低下

    建立**索引表**，包含指向记录的**指针**和**记录长度**

    索引表按<u>关键字排序</u>，故也是**定长记录顺序文件**，<u>将变长记录顺序文件顺序检索，转化为定长记录索引文件随机检索</u>

    索引表增加了存储占用

    ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202407212034656.png)​
3. **索引顺序文件**

    <u>顺序文件和索引文件的结合</u>

    将<u>变长记录顺序文件</u>中所有记录分组，将<u>分组后的第一个记录</u>添加到新建立的索引表中，建立一个表项

    变长记录顺序文件（逻辑文件）中同组内关键字可以无序，但组与组之间必须有序

    查找时，先查找索引表确定分组，在组中再顺序查找

    ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202407212043957.png)​

    顺序文件查找平均次数$\frac N2$，索引顺序文件查找平均次数$\sqrt{N}$
4. **直接文件/散列文件（Hash File）**

    给定记录的键值或通过散列函数转换的键值直接决定记录的物理地址

    散列文件具有很高的存取速度，但是会引起冲突，即不同关键字的散列函数值可能相同

### 文件的物理结构

即文件数据在物理设备上是如何分布和组织的

文件在磁带上--->连续存放方式  
文件在磁盘上--->不采用连续存放方式  
文件在内存上--->随机存放方式

#### 连续分配

每个文件在磁盘上有<u>一组连续的块</u>

文件的记录项记录文件<u>第一个磁盘块块号和占用块数</u>

​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202407212137434.png)​

**优点：**

1. 支持<u>顺序访问和直接访问</u>
2. 顺序访问容易且速度快，文件所<u>占用的块位于相邻磁道</u>

**缺点：**

1. 连续分配时将产生外部碎片，与<u>内存分配类似</u>
2. 必须知道文件长度，且<u>无法动态增长占用空间</u>
3. 为保持有序性，删除和插入记录时需要<u>对相邻记录物理移动</u>

#### 链接分配

一种<u>离散分配</u>方式

**优点：**

1. 消除磁盘外部碎片，提高利用率
2. 便于动态分配盘块
3. 插入删除修改方便​​

分为两种方式：**隐式链接**和**显示链接**

1. **隐式链接**

    * **概念**

      目录项含有文件<u>第一和最后块块号</u>

      除最后一块，每一块都保存指向下一个块的指针，用户可见

      ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202407212137027.png)​
    * **缺点：**

      1. 仅支持<u>顺序访问</u>
      2. <u>不稳定</u>，任何一个指针出问题文件将丢失
      3. 存储指针也需要消耗空间
    * **改进**

      将<u>几个盘块组成一个簇</u>，按簇进行分配，可以大幅减少查找时间，同时可以节省指针的空间占用
2. **显示链接**

    * **概念**

      链接各个块的指针，显式存放于内存的链接表中，一个磁盘一张，即**文件分配表（File Allocation Table,FAT）**

      <u>表项中存放下一个盘块指针，文件目录只记录文件起始块号</u>

      ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202407252033539.png)​
    * 优点

      1. 支持<u>顺序访问和直接访问</u>
      2. <u>FAT在系统启动时读入内存</u>，检索在内存中进行，提高了速度，减少访问磁盘速度，但需要占用一定内存

#### 索引分配

1. **单级索引分配方式**

    * **概念**

      <u>一个文件创建一个索引块</u>，将该文件的所有<u>盘块号都记录在索引块</u>中

      打开某个文件就将文件对应的索引块调入，无需加载整个FAT

      ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202407252049994.png)​
    * **优点**

      1. 支持<u>直接访问</u>，即索引块第i块即文件第i块
      2. <u>不会产生外部碎片</u>
    * **缺点**

      * 增加额外存储开销
      * 小文件索引块**利用率低**
      * 大文件链接多个索引块**效率低**
2. **多级索引分配方式**

    * **概念**

      设置一主索引，将索引块盘块号填入，即二级索引分配方式

      类似内存管理多级页表

      文件过大还可以继续增加级数

      ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202407252054657.png)​
    * **优点**

      极大<u>加快大型文件查找速度</u>
    * **缺点**

      访问文件时，<u>启动磁盘次数随索引级数增加而增加</u>
3. **混合索引分配方式**

    * **概念**

      * 小文件直接使用FCB，**直接寻址**
      * 中文件单级索引，**一次寻址**
      * 大文件二级三级索引分配

      ​![image](https://image-host-pkj.oss-cn-guangzhou.aliyuncs.com/202407252109720.png)​
    * **计算**

      假设一个块4KB

      1. **直接地址**

          文件不大于**40KB**，也就是10个块时，可以直接从索引节点中读出全部块号
      2. **一次间接地址**

          一次间址块中可以存放1024个盘块号

          即可以表示不大于1000 x 4KB = **4MB**大小的文件

          一次间址与直接地址同时使用时取和即**4MB+40KB**
      3. **多次间接地址**

          二次间址时可以表示1K x 1K x 1024 = **4GB**大小文件

          同时使用时最大**4GB+4MB+40KB**

          三次即再**增加4TB**

‍
